name: Full CD

on:
  workflow_run:
    workflows: ["Delivery"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.AZURE_VM_SSH_KEY }}

      - name: Add Azure VM to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.AZURE_VM_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to Azure VM
        env:
          GHCR_USERNAME: ${{ github.repository_owner }}
          GHCR_REGISTRY: ghcr.io
        run: |
          ssh ${{ secrets.AZURE_VM_USER }}@${{ secrets.AZURE_VM_HOST }} << 'EOF'
            set -e

            # Opret app-mappen, hvis den ikke findes
            mkdir -p ${{ secrets.AZURE_VM_APP_PATH }}
            cd ${{ secrets.AZURE_VM_APP_PATH }}

            # Login to GHCR (use PAT stored in AZURE_VM_GHCR_PAT)
            echo ${{ secrets.AZURE_VM_GHCR_PAT }} | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin

            # Pull the latest image built by Delivery
            docker pull ghcr.io/${{ github.repository_owner }}/whoknows-next-gen:latest || true
            docker pull ghcr.io/${{ github.repository_owner }}/whoknows-next-gen:$(cat /tmp/image-sha || echo latest) || true

            # Tag image locally
            docker image inspect ghcr.io/${{ github.repository_owner }}/whoknows-next-gen:${{ github.sha }} >/dev/null 2>&1 && IMAGE=ghcr.io/${{ github.repository_owner }}/whoknows-next-gen:${{ github.sha }} || IMAGE=ghcr.io/${{ github.repository_owner }}/whoknows-next-gen:latest

            # Ensure execute permissions for app scripts
            if [ -d bin ]; then
              sed -i '1 s|ruby.exe|/usr/local/bin/ruby|' bin/* || true
              chmod +x bin/rails || true
            fi

            # Restart container using the pulled image
            if docker ps -q -f name=whoknows-next-gen-web-1; then
              docker rm -f whoknows-next-gen-web-1 || true
            fi
            docker run -d --name whoknows-next-gen-web-1 -p 3000:3000 ghcr.io/${{ github.repository_owner }}/whoknows-next-gen:latest
          EOF
