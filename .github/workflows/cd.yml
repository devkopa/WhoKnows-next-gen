name: Full CD

on:
  workflow_run:
    workflows: ["Delivery"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.AZURE_VM_SSH_KEY }}

      - name: Add Azure VM to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.AZURE_VM_HOST }} >> ~/.ssh/known_hosts

      - name: Install GitHub CLI
        run: sudo apt-get update && sudo apt-get install -y gh jq unzip

      - name: Download image metadata from Delivery
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Listing artifacts for workflow run ${{ github.event.workflow_run.id }}..."
          ARTIFACT_ID=$(gh run-artifacts ${{ github.event.workflow_run.id }} --repo ${{ github.repository }} --json id,name \
            | jq -r '.[] | select(.name=="image-info") | .id')

          if [ -z "$ARTIFACT_ID" ]; then
            echo "Artifact 'image-info' not found. Exiting."
            exit 1
          fi

          echo "Found artifact ID: $ARTIFACT_ID. Downloading..."
          gh run-artifact download "$ARTIFACT_ID" --repo ${{ github.repository }} --dir /tmp

      - name: Read image info
        id: read-image
        run: echo "IMAGE=$(cat /tmp/image-info.txt | cut -d= -f2)" >> $GITHUB_ENV

      - name: Deploy to Azure VM
        env:
          GHCR_USERNAME: ${{ github.repository_owner }}
          GHCR_REGISTRY: ghcr.io
          AZURE_VM_GHCR_PAT: ${{ secrets.AZURE_VM_GHCR_PAT }}
        run: |
          ssh ${{ secrets.AZURE_VM_USER }}@${{ secrets.AZURE_VM_HOST }} 'bash -s' <<'EOF'
            set -e

            APP_PATH='${{ secrets.AZURE_VM_APP_PATH }}'
            CONTAINER_NAME='whoknows-next-gen-web-1'
            IMAGE="${IMAGE}"

            mkdir -p "$APP_PATH"
            cd "$APP_PATH"

            echo "$AZURE_VM_GHCR_PAT" | docker login ghcr.io -u '${{ github.repository_owner }}' --password-stdin

            docker pull "$IMAGE" || true
            docker pull ghcr.io/${{ github.repository_owner }}/whoknows-next-gen:latest || true

            if [ -d bin ]; then
              sed -i '1 s|ruby.exe|/usr/local/bin/ruby|' bin/* || true
              chmod +x bin/rails || true
            fi

            CID=$(docker ps -q -f name=$CONTAINER_NAME)
            if [ -n "$CID" ]; then
              echo "Stopping container $CONTAINER_NAME (CID=$CID)..."
              PID=$(docker inspect --format '{{.State.Pid}}' $CID)
              echo "Container PID: $PID"
              sudo kill -9 $PID || true
              docker rm $CID || true
            fi

            docker run -d --name $CONTAINER_NAME -p 3000:3000 "$IMAGE"
          EOF
