name: CD

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.AZURE_VM_SSH_KEY }}

      - name: Add Azure VM to known_hosts
        env:
          AZURE_VM_HOST: ${{ secrets.AZURE_VM_HOST }}
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "$AZURE_VM_HOST" >> ~/.ssh/known_hosts

      - name: Deploy latest image from GHCR
        env:
          AZURE_VM_USER: ${{ secrets.AZURE_VM_USER }}
          AZURE_VM_HOST: ${{ secrets.AZURE_VM_HOST }}
          AZURE_VM_APP_PATH: ${{ secrets.AZURE_VM_APP_PATH }}
          GHCR_PAT: ${{ secrets.AZURE_VM_GHCR_PAT }}
        run: |
          ssh "$AZURE_VM_USER@$AZURE_VM_HOST" << 'EOF'
            set -e

            # Install Docker if not present
            if ! command -v docker &> /dev/null; then
              echo "Docker not found. Installing Docker..."
              sudo apt-get update
              sudo apt-get install -y ca-certificates curl gnupg
              sudo install -m 0755 -d /etc/apt/keyrings
              curl -fsSL https://get.docker.com | sudo sh
              sudo usermod -aG docker $USER
              echo "Docker installed."
            else
              echo "Docker already installed."
            fi

            # Ensure Docker Compose v2 is available
            if ! docker compose version &> /dev/null; then
              echo "Docker Compose not found. Installing plugin..."
              sudo mkdir -p /usr/local/lib/docker/cli-plugins
              sudo curl -SL https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64 \
                -o /usr/local/lib/docker/cli-plugins/docker-compose
              sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
              echo "Docker Compose installed."
            else
              echo "Docker Compose already installed."
            fi

            IMAGE_NAME=ghcr.io/devkopa/whoknows-next-gen
            APP_PATH="$AZURE_VM_APP_PATH"

            mkdir -p "$APP_PATH"
            cd "$APP_PATH"

            echo "Logging in to GHCR..."
            echo "$GHCR_PAT" | docker login ghcr.io -u '${{ github.actor }}' --password-stdin

            echo "Pulling latest images..."
            docker compose pull

            echo "Starting/Updating containers..."
            docker compose up -d --remove-orphans

            echo "Deployment complete! Running containers:"
            docker compose ps
          EOF
