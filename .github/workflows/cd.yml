name: Full CD

on:
  workflow_run:
    workflows: ["Delivery"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.AZURE_VM_SSH_KEY }}

      - name: Add Azure VM to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.AZURE_VM_HOST }} >> ~/.ssh/known_hosts

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq unzip curl

      - name: Download image metadata from Delivery
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Listing artifacts for workflow run ${{ github.event.workflow_run.id }}..."
          ARTIFACT_URL=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/artifacts \
            | jq -r '.artifacts[] | select(.name=="image-info") | .archive_download_url')

          if [ -z "$ARTIFACT_URL" ]; then
            echo "Artifact 'image-info' not found. Exiting."
            exit 1
          fi

          echo "Downloading artifact from $ARTIFACT_URL..."
          curl -L -H "Authorization: token $GITHUB_TOKEN" "$ARTIFACT_URL" -o /tmp/image-info.zip
          unzip -o /tmp/image-info.zip -d /tmp

      - name: Read image info
        id: read-image
        run: echo "IMAGE=$(cat /tmp/image-info.txt | cut -d= -f2)" >> $GITHUB_ENV

      - name: Deploy to Azure VM
        env:
          GHCR_USERNAME: ${{ github.repository_owner }}
          GHCR_REGISTRY: ghcr.io
          AZURE_VM_GHCR_PAT: ${{ secrets.AZURE_VM_GHCR_PAT }}
        run: |
          ssh ${{ secrets.AZURE_VM_USER }}@${{ secrets.AZURE_VM_HOST }} \
          "AZURE_VM_GHCR_PAT='${{ secrets.AZURE_VM_GHCR_PAT }}' IMAGE='${{ env.IMAGE }}' bash -s" <<EOF
            set -e

            APP_PATH='${{ secrets.AZURE_VM_APP_PATH }}'
            CONTAINER_NAME='whoknows-next-gen-web-1'

            mkdir -p "\$APP_PATH"
            cd "\$APP_PATH"

            # Debug: tjek token lÃ¦ngde
            echo "PAT length: \${#AZURE_VM_GHCR_PAT}"

            # Login til GHCR non-interaktivt
            echo "\$AZURE_VM_GHCR_PAT" | docker login ghcr.io -u '${{ github.repository_owner }}' --password-stdin

            # Pull images
            docker pull "\$IMAGE" || true
            docker pull ghcr.io/${{ github.repository_owner }}/whoknows-next-gen:latest || true

            # Fix bin scripts hvis de findes
            if [ -d bin ]; then
              sed -i '1 s|ruby.exe|/usr/local/bin/ruby|' bin/* || true
              chmod +x bin/rails || true
            fi

            # Stop eksisterende container og fjern den forcefully
            CID=\$(docker ps -q -f name=\$CONTAINER_NAME)
            if [ -n "\$CID" ]; then
              echo "Stopping and removing container \$CONTAINER_NAME (CID=\$CID)..."
              docker rm -f \$CID || true
            fi

            # Start container
            docker run -d --name \$CONTAINER_NAME -p 3000:3000 "\$IMAGE"
          EOF
