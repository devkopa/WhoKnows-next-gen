name: Full CD

on:
  workflow_run:
    workflows: ["Delivery"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.AZURE_VM_SSH_KEY }}

      - name: Add Azure VM to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.AZURE_VM_HOST }} >> ~/.ssh/known_hosts

      - name: Download image metadata from Delivery
        uses: actions/download-artifact@v4
        with:
          name: image-info
          path: /tmp

      - name: Read image info
        id: read-image
        run: echo "IMAGE=$(cat /tmp/image-info.txt | cut -d= -f2)" >> $GITHUB_ENV

      - name: Deploy to Azure VM
        env:
          GHCR_USERNAME: ${{ github.repository_owner }}
          GHCR_REGISTRY: ghcr.io
          AZURE_VM_GHCR_PAT: ${{ secrets.AZURE_VM_GHCR_PAT }}
        run: |
          ssh ${{ secrets.AZURE_VM_USER }}@${{ secrets.AZURE_VM_HOST }} 'bash -s' <<'EOF'
            set -e

            APP_PATH='${{ secrets.AZURE_VM_APP_PATH }}'
            CONTAINER_NAME='whoknows-next-gen-web-1'
            IMAGE="${IMAGE}"

            # Opret app-mappen, hvis den ikke findes
            mkdir -p "$APP_PATH"
            cd "$APP_PATH"

            # Login til GHCR med PAT
            echo "$AZURE_VM_GHCR_PAT" | docker login ghcr.io -u '${{ github.repository_owner }}' --password-stdin

            # Pull de nyeste images
            docker pull "$IMAGE" || true
            docker pull ghcr.io/${{ github.repository_owner }}/whoknows-next-gen:latest || true

            # Ensure execute permissions for app scripts
            if [ -d bin ]; then
              sed -i '1 s|ruby.exe|/usr/local/bin/ruby|' bin/* || true
              chmod +x bin/rails || true
            fi

            # Stop eksisterende container via PID, hvis den kÃ¸rer
            CID=$(docker ps -q -f name=$CONTAINER_NAME)
            if [ -n "$CID" ]; then
              echo "Stopping container $CONTAINER_NAME (CID=$CID)..."
              PID=$(docker inspect --format '{{.State.Pid}}' $CID)
              echo "Container PID: $PID"
              sudo kill -9 $PID || true
              docker rm $CID || true
            fi

            # Start ny container
            docker run -d --name $CONTAINER_NAME -p 3000:3000 "$IMAGE"
          EOF